<!DOCTYPE html>
<html>

<!--

06/22/22 update: The editor now logs keystrokes and stores them in a Firebase database.
It also includes an input box (use input() in Python and readline() in JS to read each line of input) and allows for long, scrollable multi-line output.
Every time you use the editor, it generates a random "session ID", a 9-digit key for which the database will store your keystrokes for this session under.
If you would like to see your keystrokes played back, run visualizer.html and paste in your session ID.
Several example codes to play back in the visualizer:
A + B in Python: 721609702
FizzBuzz in Python: 617732400
Combinatorics (N choose K) and Binary Exponentiation in Python: 79520296
Solution to Codeforces 1694A in Python: 58266358
A + B in JavaScript: 251894852
All problems solved: 240002487

06/27/22 update: The editor includes automated testing! Problems are located in the "problems" folder -
The editor currently includes 12 example problems I made (sorted from easiest to hardest)
To create and add a problem, create a text file in the "problems" folder, and follow the format of the template.txt problem example. Add the name of the text file (excluding the .txt) to the "problemset" list on line 457, in its appropriate position in the list.

TODO:
* More detailed error messages
* Support for floating point numbers as input/output

!-->

    <head>
        <meta charset="utf-8">
        <title>Keylogging IDE</title>
        <script src="https://www.gstatic.com/firebasejs/5.5.1/firebase.js"></script>
        <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js">
        </script>
        <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js">
        </script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
        <style>
          .text-labels {
            font-family: 'Monaco';
          }
          canvas {display: block; }
          body {margin: 0; }
          map {
            position: absolute;
          }
          #editor {
            position: absolute;

            top: 210px;
            bottom: 50px;
            right: 50%;
            /* left: 5%; */
            left: 1%;

            /* border-style: solid; */

          }
          #input {
            position: absolute;
            top: 240px;
            height: 100px;
            right: 10%;
            left: 55%;
            padding: 20px;
            border-style: solid;
            border-color: 'rgb(0,0,0)';
            border-width: 2px;
            border-radius: 12px;
            font-size: 20px;
            text-align: left;
            font-family: 'Monaco';
            overflow: auto;
          }
          #output {
            position: absolute;
            top: 390px;
            bottom: 50px;
            right: 10%;
            left: 55%;
            padding: 20px;
            border-style: solid;
            border-color: 'rgb(0,0,0)';
            border-width: 2px;
            border-radius: 12px;
            font-size: 20px;
            text-align: left;
            font-family: 'Monaco';
            overflow: auto;
          }
          .button {
            position: absolute;

            border-style: none;
            font-family: 'Avenir', 'Montserrat';
            font-size: 23px;
            border-radius: 12px;
            cursor: pointer;
          }
          #selectjs {
            color: rgba(0, 0, 0, 1);
            /* top: 141px; */
            top: 90px;
            height: 40px;
            background-color: rgba(200, 200, 200, 1);
            left: 0%;
            right: 50%;
            border-radius: 0px;
          }
          #backgroundjs {
            color: rgba(240, 120, 0, 1);
            /* top: 141px; */
            top: 90px;
            height: 40px;
            background-color: rgba(0, 0, 80, 1);
            left: 0%;
            right: 50%;
            border-radius: 0px;
          }
          #selectpython {
            color: rgba(0, 0, 0, 1);
            /* top: 141px; */
            top: 90px;
            height: 40px;
            background-color: rgba(200, 200, 200, 1);
            left: 50%;
            right: 0%;
            border-radius: 0px;
          }
          #backgroundpython {
            color: rgba(0, 0, 80, 1);
            /* top: 141px; */
            top: 90px;
            height: 40px;
            background-color: rgba(240, 120, 0, 1); /* go orange */
            left: 50%;
            right: 0%;
            border-radius: 0px;
          }
          #runjs {
            background-color: rgba(0, 150, 50, 0.8);
            top: 195px;
            left: 23%;
            right: 67%;
          }
          #runpython {
            top: 195px;
            background-color: rgba(0, 150, 50, 0.8);
            left: 23%;
            right: 67%;
          }
          #title {
            font-family: 'AvenirNext-Bold';
            text-align: center;
            /* font-size: 80px; */
            font-size: 40px;
            margin-top: 0px;
          }
          #subtitle {
            font-family: 'Avenir', 'Montserrat';
            text-align: center;
            font-size: 23px;
            /* margin-top: -6px; */
            margin-top: 0px;
          }
          #select {
            font-family: 'Avenir', 'Montserrat';
            font-size: 22px;
            margin-left: 50%;
            margin-right: 0%;
            text-align: center;
            margin-top: 63px;
          }
          #select2 {
            font-family: 'Avenir', 'Montserrat';
            font-size: 22px;
            margin-left: 50%;
            margin-right: 0%;
            text-align: center;
            margin-top: 8px;
          }
          #buttonplace {
            margin-top: 10px;
            margin-left: 50%;
          }
          .buttons {
            background-color: rgb(220, 220, 220);
            height: 25px;
            font-family: 'Avenir', 'Montserrat';
            font-size: 15px;
            border-style: none;
            padding-left: 5px;
            padding-right: 5px;
            color: rgb(0, 0, 0);
            cursor: pointer;

          }
          .buttons2 {
            background-color: rgb(220, 220, 220);
            border-color: rgb(0, 0, 200);
            border-radius: 3px;
            height: 25px;
            font-family: 'Avenir', 'Montserrat';
            font-size: 15px;
            padding-left: 5px;
            padding-right: 5px;
            color: rgb(0, 0, 0);
            cursor: pointer;
          }
          .solved {
            background-color: rgba(0, 220, 0, 0.3);
            height: 25px;
            font-family: 'Avenir', 'Montserrat';
            font-size: 15px;
            border-style: none;
            padding-left: 5px;
            padding-right: 5px;
            color: rgb(0, 0, 0);
            cursor: pointer;

          }
          .solved2 {
            background-color: rgba(0, 220, 0, 0.3);
            border-color: rgb(0, 0, 200);
            border-radius: 3px;
            height: 25px;
            font-family: 'Avenir', 'Montserrat';
            font-size: 15px;
            padding-left: 5px;
            padding-right: 5px;
            color: rgb(0, 0, 0);
            cursor: pointer;
          }
          #prob {
            position: absolute;
            /* top: 320px; */
            top: 250px;
            /* height: 150px; */
            height: 60px;
            right: 1%;
            left: 51%;
            padding: 20px;
            border-style: solid;
            border-color: 'rgb(0,0,0)';
            border-width: 1px;
            border-radius: 12px;
            font-size: 20px;
            text-align: left;
            font-family: 'Monaco';
            overflow: auto;
          }
          #res1 {
            font-size: 17px;
            font-family: 'Avenir', 'Montserrat';
            text-align: center;
            margin-bottom: 8px;
          }
          #res2 {
            font-size: 17px;
            font-family: 'Avenir', 'Montserrat';
            text-align: center;
            margin-bottom: 8px;
          }
          #res3 {
            font-size: 17px;
            font-family: 'Avenir', 'Montserrat';
            text-align: center;
            margin-bottom: 14px;
          }
          #testcases {
            position: absolute;
            /* top: 530px; */
            top: 370px;
            bottom: 40px;
            right: 1%;
            left: 51%;
            padding: 20px;
            border-style: solid;
            border-color: 'rgb(0,0,0)';
            border-width: 1px;
            border-radius: 12px;
            font-size: 20px;
            text-align: left;
            font-family: 'Monaco';
            overflow: auto;
            font-size: 17px;

          }
          #survey {
            position: absolute;
            top: 210px;
            bottom: 40px;
            right: 1%;
            left: 51%;
            padding: 20px;
            border-style: solid;
            border-color: 'rgb(0,0,0)';
            border-width: 1px;
            border-radius: 12px;
            font-size: 20px;
            text-align: left;
            font-family: 'Monaco';
            overflow: auto;
          }
          #probtitle {
            margin-top: 0px;
            margin-left: 0%;
            margin-right: 0%;
            font-size: 28px;
            font-family: 'AvenirNext-Bold';
            text-align: center;
          }

          #statement {
            margin-left: 0%;
            margin-right: 0%;
            padding-left: 15px;
            padding-right: 15px;
            font-size: 19px;
            font-family: 'Avenir', 'Montserrat';
            margin-top: -22px;
            text-align: left;
          }


          .green {
            background-color: rgba(0, 200, 0, 0.3);
            text-align: center;
            padding-left: 0px;
            padding-right: 0px;
          }

          .red {
            background-color: rgba(200, 0, 0, 0.3);
            text-align: center;
            padding-left: 0px;
            padding-right: 0px;
          }

          .gray {
            background-color: rgba(220, 220, 220);
            text-align: center;
            padding-left: 0px;
            padding-right: 0px;
          }

          #testcase {
            display: flex;
            padding-top: 10px;
            padding-bottom: 10px;
            color: rgb(255, 0, 0);
            border-style: none;
            width: 100%;
          }

          #number {
            position: absolute;
            margin-left: 1%;
            width: 17%;
            padding-top: 7px;
            text-align: center;
            font-family: 'AvenirNext-Bold';
            font-size: 17px;
          }

          #data {
            position: absolute;
            margin-left: 19%;
            width: calc(17% - 12px);
            padding-top: 6px;
            padding-left: 12px;
            padding-right: 0px;
            font-family: 'Monaco';
            font-size: 17px;
            text-align: left;

            overflow: auto;
            whitespace: nowrap;
          }

          #expected {
            position: absolute;
            margin-left: 37%;
            width: calc(17% - 5px);
            padding-top: 6px;
            padding-left: 12px;
            padding-right: 0px;
            font-family: 'Monaco';
            font-size: 17px;
            overflow: auto;
            whitespace: nowrap;
            text-align: left;

          }

          #testoutput {
            position: absolute;
            margin-left: 56%;
            width: calc(17% - 12px);
            padding-top: 6px;
            padding-left: 12px;
            padding-right: 0px;
            font-family: 'Monaco';
            font-size: 17px;

            overflow: auto;
            whitespace: nowrap;
            text-align: left;

          }

          #debug {
            position: absolute;
            margin-left: 74%;
            width: calc(17.5%);
            padding-top: 6px;
            padding-left: 12px;
            padding-right: 0px;
            font-family: 'Monaco';
            font-size: 17px;

            overflow: auto;
            whitespace: nowrap;
            text-align: left;

          }


          #lnumber {
            position: absolute;
            margin-left: -1%;
            width: 22%;
            height: 30px;
            text-align: center;
            font-family: 'AvenirNext-Bold';
            font-size: 15px;
          }

          #ldata {
            position: absolute;
            margin-left: 19%;
            width: calc(22% - 12px);
            padding-left: 3%;
            height: 28px;
            font-family: 'AvenirNext-Bold';
            font-size: 15px;

            overflow: auto;
            whitespace: nowrap;
          }

          #lexpected {
            position: absolute;
            margin-left: 37%;
            width: calc(22% - 12px);
            padding-left: 1%;
            height: 28px;
            font-family: 'AvenirNext-Bold';
            font-size: 15px;
            overflow: auto;
            whitespace: nowrap;
          }

          #ltestoutput {
            position: absolute;
            margin-left: 56%;
            width: calc(23% - 12px);
            padding-left: 1.5%;
            height: 28px;
            font-family: 'AvenirNext-Bold';
            font-size: 15px;

            overflow: auto;
            whitespace: nowrap;
          }

          #ldebug {
            position: absolute;
            margin-left: 74%;
            width: calc(23% - 12px);
            padding-left: 2%;
            height: 28px;
            font-family: 'AvenirNext-Bold';
            font-size: 15px;

            overflow: auto;
            whitespace: nowrap;
          }

          #surveytitle {
            margin-top: 0px;
            margin-left: 0%;
            margin-right: 0%;
            font-size: 28px;
            font-family: 'AvenirNext-Bold';
            text-align: center;
          }

          #surveysub {
            margin-top: -15px;
            margin-left: 0%;
            margin-right: 0%;
            font-size: 19px;
            font-family: 'Avenir', 'Montserrat';
            text-align: center;
          }

          #question {
            margin-left: 0%;
            margin-right: 0%;
            padding-left: 15px;
            padding-right: 15px;
            font-size: 19px;
            font-family: 'Avenir', 'Montserrat';
            margin-top: 6px;
            margin-bottom: 6px;
            text-align: left;
          }

          #surveyinput {
            margin-left:15px;
            margin-right: 0%;
            font-size: 19px;
            font-family: 'Avenir', 'Montserrat';
            text-align: left;
            margin-bottom: 14px;
            width: calc(100% - 40px);
          }

          #surveyslider {
            margin-top: 5px;
            margin-left: 15px;
            width: calc(100% - 40px);
          }

          #surveynum {
            margin-top: 10px;
            margin-left: 15px;
            font-family: 'Avenir', 'Montserrat';
            font-size: 19px;
            width: calc(100% - 40px);
          }

          .surveybutton {
            margin-left: 15px;
            border-style: none;
            font-family: 'Avenir', 'Montserrat';
            font-size: 17px;
            background-color: rgba(200, 200, 200, 0.5);
            border-radius: 3px;
            margin-bottom: 15px;
            cursor: pointer;
          }

          #nextbutton {
            margin-left: calc(50% - 70px);
            margin-right: calc(50% - 70px);
            text-align: center;
            border-style: none;
            font-family: 'Avenir', 'Montserrat';
            font-size: 17px;
            background-color: rgba(0, 200, 0, 0.5);
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
            margin-top: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
          }

          #giveup {
            margin-left: calc(75% - 32px);
            text-align: center;
            border-style: none;
            font-family: 'Avenir', 'Montserrat';
            font-size: 17px;
            background-color: rgba(200, 0, 0, 0.5);
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
            margin-top: 9px;
            padding-top: 3px;
            padding-bottom: 3px;
            padding-left: 10px;
            padding-right: 10px;
            /* display: none; /\* dont let participants give up *\/ */
          }

          #signin {
            margin-top: 20px;
            margin-left: 20%;
            background-color: rgb(0, 0, 80);
            color: rgb(200, 150, 0);
            font-family: 'Avenir';
            font-size: 22px;
            border-style: none;
            border-radius: 4px;
            padding-top: 2px;
            padding-bottom: 2px;
            cursor: pointer;
            width: 60%;
          }

          #signout {
            margin-left: 30px;
            background-color: rgb(0, 0, 80);
            color: rgb(200, 150, 0);
            font-family: 'Avenir';
            font-size: 22px;
            border-style: none;
            border-radius: 4px;
            padding-top: 2px;
            padding-bottom: 2px;
            cursor: pointer;
          }

          #restartbutton {
            margin-left: 30px;
            background-color: rgb(0, 0, 80);
            color: rgb(200, 150, 0);
            font-family: 'Avenir';
            font-size: 22px;
            border-style: none;
            border-radius: 4px;
            padding-top: 2px;
            padding-bottom: 2px;
            cursor: pointer;
          }

          #tutorial_code {
            font-family: 'Monaco';
            font-size: 15px;
            background-color: rgb(230, 230, 230);
            padding-left: 10px;
            padding-right: 10px;
          }

          #tutorial_normal {
            font-family: 'Avenir';
            font-size: 20px;
            margin-top: 5px;
            margin-bottom: 5px;
          }

          #tutorial_med {
            font-family: 'Avenir';
            font-size: 30px;
            margin-top: 5px;
            margin-bottom: 5px;
          }

          #tutorial_big {
            font-family: 'Avenir';
            font-size: 40px;
            margin-top: 5px;
            margin-bottom: 5px;
          }

          #tutorial_huge {
            font-family: 'Avenir';
            font-size: 50px;
            margin-top: 5px;
            margin-bottom: 5px;
          }



        </style>
    </head>

  <body onload="brython()">

  <div id="title">Keylogging IDE</div>

  <div id="prelogin">
    <button id="signin">Sign In (use a Google email account)</button>
  </div>

  <div id="loggedin" hidden=true>
  <div id="subtitle"><span id="id">Session ID: </span><button id="signout">Log Out</button><button id="restartbutton">Restart Session</button></div>

  <!-- Buttons for switching languages !-->
  <button type="button" class="button" id="selectpython" onclick="python()"> Python  </button>
  <button type="button" class="button" id="selectjs" onclick="js()"> JavaScript  </button>
  <button type="button" class="button" id="backgroundpython" hidden=true>  Python </button>
  <button type="button" class="button" id="backgroundjs">  JavaScript </button>

  <!-- Information at the top of the problem page !-->
  <div id="select">Current Problem:</div>
  <div id="select2">Time Remaining: <strong id="timeleft"></strong></div>
  <button id="giveup" onclick=giveup()>Give Up</button>

  <!-- Template for the problem text, the content for which is added in the JS portion of the code later !-->
  <div id="prob">
    <p id="probtitle"></p>
    <p id="statement"></p>
  </div>
  <div id="testcases"></div>
  <div id="survey" hidden=true></div>

  <!-- Template for the editor, also added later in the JS code !-->
  <div id="editor"></div>

  <!-- Hidden text fields used to communicate data between this file and database.js
       Using firebase requires import statements at the top of the JS code, which require you to put them in a separate js file and import it as a module
       So database.js does all the firebase stuff, and these fields are used to communicate information with that file. !-->
  <div hidden=true id="text"></div>
  <div hidden=true id="inputtext"></div>
  <div hidden=true id="edit"></div>
  <div hidden=true id="editortype">javascript</div>
  <div hidden=true id="sig"></div>
  <div hidden=true id="args"></div>
  <div hidden=true id="time"></div>
  <div hidden=true id="pyresult"></div>
  <div hidden=true id="pydebug"></div>
  <div hidden=true id="index"></div>
  <div hidden=true id="curtestcase"></div>
  <div hidden=true id="starttime"></div>
  <div hidden=true id="lasttest"></div>
  <div hidden=true id="lastprob"></div>
  <div hidden=true id="laststart"></div>
  <div hidden=true id="jsdebug"></div>
  <div hidden=true id="surveyanswers"></div>
  <div hidden=true id="probid"></div>
  <div hidden=true id="uid"></div>
  <div hidden=true id="email"></div>
  <div hidden=true id="name"></div>
  <div hidden=true id="send_problem"></div>
  <div hidden=true id="send_pycode"></div>
  <div hidden=true id="send_jscode"></div>
  <div hidden=true id="send_solvecount"></div>
  <div hidden=true id="send_status"></div>
  <div hidden=true id="send_lang"></div>
  <div hidden=true id="send_timeleft"></div>
  <div hidden=true id="preload"></div>
  <div hidden=true id="restart"></div>


  <div>

  <!-- imports the editor library !-->
  <script src="./ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="./ace-builds/ext_language_tools.js"></script>

  <script src="./database.js" type="module"></script>

  <script>

    var veryStart = Date.now();

    var uid;
    var email;
    var name;

    function checkLogin() {
      if (document.getElementById("uid").innerHTML.length > 0) {
        uid = document.getElementById("uid").innerHTML;
        email = document.getElementById("email").innerHTML;
        name = document.getElementById("name").innerHTML;
        document.getElementById("uid").innerHTML = "";
        document.getElementById("prelogin").hidden = true;
        document.getElementById("loggedin").hidden = false;
        document.getElementById("id").innerHTML = "Logged in as " + name + " (Session ID of " + uid + ")";
      }

      window.requestAnimationFrame(checkLogin, 1);
    }

    checkLogin();
    //Start of the JS code in the project (some is also in database.js)

    //Keys array used to check which key the user has pressed
    var keys = [];
    for (var i = 0 ; i < 500 ; i++) {
      keys[i] = 0;
    }

    document.addEventListener("keydown", function(event) {
      keys[event.keyCode] = 1;
      if (event.metaKey) {
        keys[event.keyCode] = 2; //Checks if a user did "Command-[key]", used in copy-paste detection
      }
    });

    document.addEventListener("keyup", function(event) {
      if (keys[event.keyCode] == 2) {
        for (var i = 0 ; i < 500 ; i++) {
          if (keys[i] == 2) {
            keys[i] = 0;
          }
        }
      }
      keys[event.keyCode] = 0;
    });

    var langs = [];
    var problemset = [];
    var correct;
    var times = [];
    var surveys = [];
    var tutorials = [];
    var tutorialtext = [];
    var presurvey;
    var postsurvey;
    var surveydata = [];
    var answers = [];
    var survey = true;
    var tutorial = false;
    var lastsurvey = false;
    var problem = -1;
    var totsolved = 0;
    var problemStart = Date.now();

    function readConfigFile(name) { //Reads the config file and adds the information to the problemset list and surveys list
      var file = "./" + name + ".txt";
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", file, false);
      rawFile.onreadystatechange = function() {
        if (rawFile.readyState === 4) {
          if (rawFile.status === 200 || rawFile.status == 0) {
            var file = rawFile.responseText;

            file = file.split("\n");
            for (var i = 0 ; i < file.length ; i++) {
              file[i] = file[i].split(" ");
              if (file[i].length < 1 || (file[i].length == 1 && file[i][0].length == 0)) {
                continue;
              }
              else if (file[i].length == 1) {
                if (problemset.length > 0) {
                  postsurvey = file[i][0];
                }
                else {
                  presurvey = file[i][0];
                }
              }
              else {
                problemset.push(file[i][0]);
                times.push(parseInt(file[i][1]));
                surveys.push(file[i][2]);
                if (file[i][3]) {
                  langs.push(file[i][3]);
                }
                else {
                  langs.push("BOTH");
                }
                if (file[i][4]) {
                  tutorials.push(file[i][4]);
                }
                else {
                  tutorials.push("");
                }
              }
            }
          }
        }
      }
      rawFile.send(null);
    }

    readConfigFile("config");

    TIME_LIMIT_MS = 500; //Time limit for all problems in milliseconds

    ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/textmate");
    editor.session.setMode("ace/mode/javascript");
    // editor.setOptions({fontSize: '12pt', behavioursEnabled: false, enableBasicAutocompletion: true, enableLiveAutocompletion: true}); // Sets up the editor
    editor.setOptions({fontSize: '18pt', behavioursEnabled: false, enableBasicAutocompletion: true, enableLiveAutocompletion: true}); // Sets up the editor
    var copyText;
    var pasted = false;

    editor.on("copy", function(text) {
      copyText = text["text"];
    });
    editor.on("paste", function(text) {
      pasted = true;
    });
    var lang = "js";

    // Sets the mode of the editor to Python
    function python() {
      lang = "python";
      document.getElementById("backgroundjs").hidden = true;
      document.getElementById("backgroundpython").hidden = false;
      document.getElementById("editortype").innerHTML = "python";
      editor.session.setMode("ace/mode/python");
    }

    // Sets the mode of the editor to JS
    function js() {
      lang = "js";
      document.getElementById("backgroundjs").hidden = false;
      document.getElementById("backgroundpython").hidden = true;
      document.getElementById("editortype").innerHTML = "javascript";
      editor.session.setMode("ace/mode/javascript");
    }

    /* List containing whether or not the user has solved each problem yet */
    var solvedpy = [];
    var solvedjs = [];

    var data = [];
    for (var i = 0 ; i < problemset.length ; i++) {
      data.push([]);
      solvedpy.push(false);
      solvedjs.push(false);
    }

    function readTextFile(name, index) { //Reads a problem
      var file = "./problems/" + name + ".txt";
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", file, false);
      rawFile.onreadystatechange = function() {
        if (rawFile.readyState === 4) {
          if (rawFile.status === 200 || rawFile.status == 0) {
            var file = rawFile.responseText;

            file = file.split("\n~~~\n");

            for (var i = 0 ; i < file.length ; i++) {
              file[i] = file[i].split("\n");
            }

            data[index] = file;

          }
        }
      }
      rawFile.send(null);
    }

    function readTutorialFile(name, problem) {
      var file = "./tutorials/" + name + ".txt";
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", file, false);
      rawFile.onreadystatechange = function() {
        if (rawFile.readyState === 4) {
          if (rawFile.status === 200 || rawFile.status == 0) {
            var file = rawFile.responseText;

            var tutorial = [];

            file = file.split("\n");

            for (var i = 0 ; i < file.length ; i++) {
              file[i] = file[i].split("").slice(1, file[i].length - 2).join("");
              var nt = "";
              for (var j = 0 ; j < file[i].length ; j++) {
                if (file[i][j] != "\\") {
                  nt += file[i][j];
                }
              }
              file[i] = nt;
            }

            for (var i = 0 ; i < file.length ; i++) {
              if (file[i].length >= 4 && file[i].split("").slice(0, 4).join("") == "[cd]") {
                var first = true;
                var last = true;
                if (i > 0 && file[i-1].length >= 4 && file[i-1].split("").slice(0, 4).join("") == "[cd]") {
                  first = false;
                }
                if (i < file.length - 1 && file[i+1].length >= 4 && file[i+1].split("").slice(0, 4).join("") == "[cd]") {
                  last = false;
                }
                if (first && !last) {
                  tutorial.push("<pre id=\"tutorial_code\">" + file[i].split("").slice(4, file[i].length).join("") + "<br>");
                }
                else if (!first && !last) {
                  tutorial.push(file[i].split("").slice(4, file[i].length).join("") + "<br>");
                }
                else if (last && !first) {
                  tutorial.push(file[i].split("").slice(4, file[i].length).join("") + "</pre>");
                }
                else {
                  tutorial.push("<pre id=\"tutorial_code\">" + file[i].split("").slice(4, file[i].length).join("") + "</pre>");
                }
              }
              else if (file[i].length >= 5 && file[i].split("").slice(0, 5).join("") == "[big]") {
                tutorial.push("<div id=\"tutorial_big\">" + file[i].split("").slice(5, file[i].length).join("") + "</div>");
              }
              else if (file[i].length >= 5 && file[i].split("").slice(0, 5).join("") == "[med]") {
                tutorial.push("<div id=\"tutorial_med\">" + file[i].split("").slice(5, file[i].length).join("") + "</div>");
              }
              else if (file[i].length >= 6 && file[i].split("").slice(0, 6).join("") == "[huge]") {
                tutorial.push("<div id=\"tutorial_huge\">" + file[i].split("").slice(6, file[i].length).join("") + "</div>");
              }
              else {
                tutorial.push("<div id=\"tutorial_normal\">" + file[i] + "</div>");
              }
              tutorialtext[problem] = tutorial;
            }



          }
        }
      }
      rawFile.send(null);
    }

    function readSurveyFile(name) { //Reads a survey
      var file = "./surveys/" + name + ".txt";
      var rawFile = new XMLHttpRequest();
      rawFile.open("GET", file, false);
      rawFile.onreadystatechange = function() {
        if (rawFile.readyState === 4) {
          if (rawFile.status === 200 || rawFile.status == 0) {
            var file = rawFile.responseText;

            var thissurvey = [];

            file = file.split("\n");


            for (var i = 0 ; i < file.length ; i++) {
              file[i] = file[i].split(" ");
              if (file[i].length<1) continue;
              var type = file[i][0];
              if (type == "TEXTBOX") {
                var data = file[i].slice(1, file[i].length).join(" ");
                data = data.split("").slice(1, data.length - 1).join("");
                thissurvey.push([0, data]);
              }
              else if (type == "MC") {
                var data = file[i].slice(1, file[i].length).join(" ");
                data = data.split("\"");
                question = data[1];
                var mcanswers = [];
                for (var j = 3 ; j < data.length ; j += 2) {
                  mcanswers.push(data[j]);
                }
                thissurvey.push([1, question, mcanswers]);
              }
              else if (type == "SLIDER") {
                var question = file[i].join(" ").split("\"")[1];
                var low = parseInt(file[i][file[i].length - 2]);
                var high = parseInt(file[i][file[i].length - 1]);
                thissurvey.push([2, question, low, high]);
              }
            }


            surveydata.push(thissurvey);

          }
        }
      }
      rawFile.send(null);
    }

    for (var i = 0 ; i < problemset.length ; i++) {
      readTextFile(problemset[i], i); //Reads each problem file from the problems folder
    }

    for (var i = 0 ; i < surveys.length ; i++) {
      readSurveyFile(surveys[i]); //Reads each survey file from the surveys folder
    }

    for (var i = 0 ; i < tutorials.length ; i++) {
      if (tutorials[i].length) {
        readTutorialFile(tutorials[i], i);
      }
    }

    readSurveyFile(presurvey);
    readSurveyFile(postsurvey);

    var presurveydata = surveydata[surveydata.length - 2];
    var postsurveydata = surveydata[surveydata.length - 1];

    var ind = 1;

    var lp = -1;
    var ls = [];
    for (var i = 0 ; i < 100 ; i++) {
      ls.push(true);
    }

    var jscodes = [];
    var pycodes = [];
    var oldValue = "";
    var loadedDat = false;
    var ov = "";
    for (var i = 0 ; i < problemset.length ; i++) {
      jscodes.push("function " + data[i][2][0] + " {\n    return 0;\n}");
      pycodes.push("def " + data[i][2][0] + ":\n    ");
    } //Creates starter code for each problem

    var globalStartTime = -1;
    var imported = false;

    var global_testcases;
    var global_actanswers;
    var global_answers;
    var global_var_expected;
    var global_expected;
    var global_index;
    var global_results;
    var global_num;
    var global_sig;
    var global_debug; //Global arrays used to communicate between different functions

    var olang = "";

    function parse_testcase(tc) {
      /* Parses test data, including strings and arrays */

      if (typeof tc == 'object') {
        tc = tc.join("");
      }
      tc = tc.split("");
      var tcs = "";
      var args = [];
      var bal = 0;
      for (var j = 0 ; j < tc.length ; j++) {
        if (tc[j] == " " && bal == 0) {
          args.push(tcs);
          tcs = "";
        }
        else {
          tcs += tc[j];
          if (tc[j] == "[") {
            bal++;
          }
          if (tc[j] == "]") {
            bal--;
          }
        }
      }

      args.push(tcs);

      for (var j = 0 ; j < args.length ; j++) {
        var inp = args[j];
        if (inp[0] == "\"" || inp[0] == "'") {
          //string
          args[j] = args[j].split("").slice(1, args[j].length - 1).join("");
        }
        else if (inp[0] == "[") {
          var arrcode = "return " + inp + ";";
          var arrayAnswer = Function(arrcode)();
          /* Converts an array, formatted as a string, into an actual array.
          E.g. converts "[[1, 2, 3], [4, 5, 6], [7, 8, 9]]" into an actual 3x3 array */

          args[j] = arrayAnswer;
        }
        else {
          /* Possible addition: add support for floating point numbers */
          args[j] = parseInt(args[j]);
        }
      }

      return args;
    }

    var sets = 0;

    function updateProblem(index) {
      var changed = false;
      if (editor.getValue() != ov || index != lp || olang != lang) {
        changed = true;
      }

      if (!changed) {
        return;
      }

      //if (tutorial) return;

      var startTime = Date.now();
      globalStartTime = startTime;


      if (index == lp && olang == lang) {
        var code = editor.getValue();
        if (lang == "python") {
          pycodes[index - 1] = code;
        }
        else {
          jscodes[index - 1] = code;
        }
      }
      else {
        if (index != lp) {
          oldValue = "";
        }
        if (imported) {
          sets++;
        }
        if (lang == "python") {
          editor.setValue(pycodes[index-1]);
          editor.clearSelection();
          document.getElementById("text").innerHTML = pycodes[index-1];
        }
        else {
          console.log("setting js");
          editor.setValue(jscodes[index-1]);
          editor.clearSelection();
        }
      }

      ind = index;

      var pd = [];
      for (var i = 0 ; i < data[index - 1].length ; i++) {
        pd.push(data[index - 1][i]);
      }

      pd[0] = pd[0][0];

      //Checks whether or not the user is allowed to copy-paste external code
      var allowed = true;
      if (pd[0].split(" ")[pd[0].split(" ").length - 1] == "STRICT") {
        pd[0] = pd[0].split(" ").slice(0, pd[0].split(" ").length - 1).join(" ");
        allowed = false;
      }

      document.getElementById("probtitle").innerHTML = pd[0];
      document.getElementById("statement").innerHTML = pd[1].join("<br>");

      var testcases = [];
      for (var i = 0 ; i < pd[3].length ; i++) {
        testcases.push(pd[3][i]);
      }

      var secret = [];
      for (var i = 0 ; i < testcases.length ; i++) {
        if (testcases[i].split("")[0] == "(") {
          testcases[i] = testcases[i].split("").slice(1, testcases[i].length - 1).join("");
          secret.push(true);
        }
        else {
          secret.push(false);
        }
      }

      var expected = pd[4];

      var answers = [];
      var actanswers = [];

      var var_expected = [];

      for (var i = 0 ; i < testcases.length ; i++) {
        var_expected[i] = parse_testcase(expected[i])[0];
      }

      global_allowed = allowed;
      global_secret = secret;
      global_testcases = testcases;
      global_answers = [];
      global_actanswers = [];
      global_var_expected = var_expected;
      global_expected = expected;
      global_index = index;
      global_results = [];
      global_num = 0;
      global_debug = [];
      global_error = [];
      global_sig = pd[2][0].split("(")[0];

      for (var i = 0 ; i < testcases.length ; i++) {
        global_answers.push("");
      }

      runTest();
      /* Runs the first test case */

      lp = index;
      olang = lang;
      ov = editor.getValue();
    }

    function runTest() {
      /* Runs each test case, one by one
      After each testcase, the program sets a timeout of 1ms, so that the webpage can update the results of the last testcase before running the next one
      This makes the program much faster for problems with solutions that run close to the time limit, especially those with a high number of test cases. */

      document.getElementById("testcases").innerHTML = "";

      var cor = 0;
      var tot = 0;
      var cors = 0;
      var tots = 0;

      var bot = 0;

      document.getElementById("testcases").innerHTML += "<div id=\"res1\">Test Cases Passed: </div><div id=\"res2\">Secret Test Cases Passed: </div><div id=\"res3\">Pasting External Code: </div>";
      document.getElementById("testcases").innerHTML += "<span id=\"lnumber\" style=\"margin-top: " + (0) + "px; margin-bottom: " + bot + "px;\">" + "Test Case #" + "</span>";
      document.getElementById("testcases").innerHTML += "<span id=\"ldata\" style=\"margin-top: " + (0) + "px; margin-bottom: " + bot + "px;\">" + "Test Data" + "</span>";
      document.getElementById("testcases").innerHTML += "<span id=\"lexpected\" style=\"margin-top: " + (0) + "px; margin-bottom: " + bot + "px;\">" + "Correct Output" + "</span>";
      document.getElementById("testcases").innerHTML += "<span id=\"ltestoutput\" style=\"margin-top: " + (0) + "px; margin-bottom: " + bot + "px;\">" + "Actual Output "  + "</span>";
      document.getElementById("testcases").innerHTML += "<span id=\"ldebug\" style=\"margin-top: " + (0) + "px; margin-bottom: " + bot + "px;\">" + "Debug Output"  + "</span>";

      var ht = 25;

      for (var i = 0 ; i < global_testcases.length ; i++) {
        if (i < global_num) {
          cor += (global_results[i]);
          tot++;
          if (global_secret[i]) {
            cors += (global_results[i]);
            tots++;
          }
        }

        var oldTestCases = document.getElementById("testcases").innerHTML;

        document.getElementById("testcases").innerHTML += "<span id=\"number\" class=\"test" + i + " red\" style=\"margin-top: " + (ht) + "px; margin-bottom: " + bot + "px;\">" + (i+1) + "</span>";
        document.getElementById("testcases").innerHTML += "<span id=\"data\" class=\"test" + i + " red\" style=\"margin-top: " + (ht) + "px; margin-bottom: " + bot + "px;\">" + global_testcases[i] + "</span>";
        document.getElementById("testcases").innerHTML += "<span id=\"expected\" class=\"test" + i + " red\" style=\"margin-top: " + (ht) + "px; margin-bottom: " + bot + "px;\">" + global_expected[i] + "</span>";
        document.getElementById("testcases").innerHTML += "<span id=\"testoutput\" class=\"test" + i + " red\" style=\"margin-top: " + (ht) + "px; margin-bottom: " + bot + "px;\">" + global_answers[i]  + "</span>";
        document.getElementById("testcases").innerHTML += "<span id=\"debug\" class=\"test" + i + " red\" style=\"margin-top: " + (ht) + "px; margin-bottom: " + bot + "px;\">" + global_debug[i]  + "</span>";

        var maxHeight = 0;
        var elList = document.getElementsByClassName("test" + i);
        for (var j = 0 ; j < elList.length ; j++) {
          maxHeight = Math.max(maxHeight, elList[j].offsetHeight);
        }

        document.getElementById("testcases").innerHTML = oldTestCases;

        var iht = maxHeight;

        if (!global_secret[i]) {
          if (i < global_num && global_results[i]) {
            document.getElementById("testcases").innerHTML += "<span id=\"number\" class=\"green\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + (i+1) + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"data\" class=\"green\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_testcases[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"expected\" class=\"green\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_expected[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"testoutput\" class=\"green\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_answers[i]  + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"debug\" class=\"green\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_debug[i]  + "</span>";
          }
          else if (i < global_num) {
            document.getElementById("testcases").innerHTML += "<span id=\"number\" class=\"red\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + (i+1) + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"data\" class=\"red\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_testcases[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"expected\" class=\"red\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_expected[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"testoutput\" class=\"red\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_answers[i]  + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"debug\" class=\"red\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_debug[i]  + "</span>";
          }
          else {
            document.getElementById("testcases").innerHTML += "<span id=\"number\" class=\"gray\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + (i+1) + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"data\" class=\"gray\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_testcases[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"expected\" class=\"gray\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_expected[i] + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"testoutput\" class=\"gray\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_answers[i]  + "</span>";
            document.getElementById("testcases").innerHTML += "<span id=\"debug\" class=\"gray\" style=\"margin-top: " + (ht) + "px; height: " + (iht) + "px; margin-bottom: " + bot + "px;\">" + global_debug[i]  + "</span>";
          }
        }

        ht += iht + 12;
      }

      var col = "rgb(200, 0, 0)";
      if ((cor-cors) == (tot-tots) && (tot-tots)>0) {
        col = "rgb(0, 200, 0)";
      }
      document.getElementById("res1").innerHTML = "Visible Test Cases Passed: <strong style=\"color: " + col + "\">" + (cor-cors) + "</strong> / <strong style=\"color: " + col + "\">" + (tot-tots) + "</strong>";
      var col = "rgb(200, 0, 0)";
      if (cors == tots && tots>0) {
        col = "rgb(0, 200, 0)";
      }
      document.getElementById("res2").innerHTML = "Secret Test Cases Passed: <strong style=\"color: " + col + "\">" + cors + "</strong> / <strong style=\"color: " + col + "\">" + tots + "</strong>";
      var col = "rgb(200, 0, 0)";
      if (global_allowed) {
        col = "rgb(0, 200, 0)";
      }

      if (tot == global_testcases.length && lastEdit != 0) {
        document.getElementById("edit").innerHTML = lastEdit + "~~~" + cor + "~~~" + tot;
        // Communicates how many test cases the user passed with database.js, which will upload it to the database
        lastEdit = 0;
      }

      if (global_allowed) {
        document.getElementById("res3").innerHTML = "Pasting External Code: <strong style=\"color: " + col + "\">Allowed</strong>";
      }
      else {
        document.getElementById("res3").innerHTML = "Pasting External Code: <strong style=\"color: " + col + "\">Not Allowed</strong>";
      }

      if (global_num < global_testcases.length) {
        var args = parse_testcase(global_testcases[global_num]);

        startTime = Date.now();
        globalStartTime = startTime;

        if (lang == "js") {
          document.getElementById("jsdebug").innerHTML = "";

          aans = run(global_sig, args, startTime);


          ans = deep_convert(aans);

          global_actanswers[global_num - 1] = aans;
          global_answers[global_num - 1] = ans;

          var equal = (JSON.stringify(global_actanswers[global_num - 1]) == JSON.stringify(global_var_expected[global_num - 1]));

          global_results.push(equal);
        }
        else if (lang == "python") {
          document.getElementById("sig").innerHTML = global_sig;
          document.getElementById("args").innerHTML = global_testcases[global_num];
          document.getElementById("time").innerHTML = globalStartTime;
          document.getElementById("index").innerHTML = global_index;
          document.getElementById("curtestcase").innerHTML = global_num;
          document.getElementById("starttime").innerHTML = globalStartTime;
        }

      }
      else {
          if (cor == global_testcases.length) {
            if (lang == "python") {
              solvedpy[global_index - 1] = true;
            }
            else {
              solvedjs[global_index - 1] = true;
            }
          }
      }
    }

    function upd() {
      if (document.getElementById("restart").innerHTML.length > 0) {
        document.getElementById("restart").innerHTML = "";
        setTimeout("location.reload(true)", 1);
      }
      if (problem >= 0 && problem < problemset.length) {
        updateProblem(problem+1); //updates the current problem every frame
      }

      if (document.getElementById("preload").innerHTML.length > 0) {
        imported = true;
        var txt = document.getElementById("preload").innerHTML.split("~~~");
        var fproblem = parseInt(txt[0]);
        var fpycode = txt[1].split("^^^").join("\n");
        var fjscode = txt[2].split("^^^").join("\n");
        var fcount = parseInt(txt[3]);
        var time = parseInt(txt[4]);
        problemStart = time;
        var stat = txt[5];
        lang = txt[6];
        console.log("setting language to " + lang);
        console.log(txt);
        //console.log(txt[7]);
        //oldValue = txt[7];
        loadedDat = true;
/*
dp = []

def gp(grid, x, y):
    if dp[x][y] != -1:
        return dp[x][y]
    if grid[x][y] == 'x':
        return 0
    ans = 0
    if x > 0:
        ans += gp(grid, x - 1, y)
    if y > 0:
        ans += gp(grid, x, y - 1)
    dp[x][y] = ans
    return ans

def grid_paths(grid):
    for i in range(0, len(grid)):
        dp.append([])
        for j in range(0, len(grid[i])):
            dp[-1].append(-1)

    dp[0][0] = 1

    return gp(grid, len(grid) - 1, len(grid[0]) - 1)
    */
        if (lang == "python") {
          python();
          editor.setValue(fpycode);
        }
        else {
          js();
          editor.setValue(fjscode);
        }


        problem = fproblem;
        var npc = "";
        var i = 0;
        fpycode = fpycode.split("");
        while (i < fpycode.length) {
          if (i < fpycode.length - 4 && fpycode.slice(i, i+4).join("") == "&lt;") {
            npc += "<";
            i+=4;
          }
          else if (i < fpycode.length - 4 && fpycode.slice(i, i+4).join("") == "&gt;") {
            npc += ">";
            i+=4;
          }
          else if (i < fpycode.length - 5 && fpycode.slice(i, i+5).join("") == "&amp;") {
            npc += "&";
            i+=5;
          }
          else {
            npc += fpycode[i];
            i++;
          }
        }
        if (stat == "solving") {
          pycodes[problem] = npc;
        }
        var njc = "";
        var i = 0;
        fjscode = fjscode.split("");
        while (i < fjscode.length) {
          if (i < fjscode.length - 4 && fjscode.slice(i, i+4).join("") == "&lt;") {
            njc += "<";
            i+=4;
          }
          else if (i < fjscode.length - 4 && fjscode.slice(i, i+4).join("") == "&gt;") {
            njc += ">";
            i+=4;
          }
          else if (i < fjscode.length - 5 && fjscode.slice(i, i+5).join("") == "&amp;") {
            njc += "&";
            i+=5;
          }
          else {
            njc += fjscode[i];
            i++;
          }
        }
        if (stat == "solving") {
          jscodes[problem] = njc;
        }
        totsolved = fcount;

        if (stat == "survey") {
          survey = true;
          lastsurvey = false;
        }
        else {
          survey = false;
          problem--;
          if (stat != "tutorial") {
            tutorials[problem] = "";
            tutorial = false;
          }
          else {
            tutorial = true;
          }
          next(true);
          if (lang == "python") {
            oldValue = pycodes[problem];
          }
          else {
            oldValue = jscodes[problem];
          }
        }

        document.getElementById("preload").innerHTML = "";
      }

      if (problem >= 0 && problem < problemset.length) {
        document.getElementById("send_pycode").innerHTML = pycodes[problem].split("\n").join("~~~");
        document.getElementById("send_jscode").innerHTML = jscodes[problem].split("\n").join("~~~");
        document.getElementById("send_solvecount").innerHTML = totsolved;
        document.getElementById("send_timeleft").innerHTML = problemStart;

        if (problem < 0) {
          status = "survey";
        }

        else if (problem >= 0 && problem < problemset.length) {

          if (tutorial) {
            status = "tutorial";
            document.getElementById("send_problem").innerHTML = problem+1;
          }
          else if (survey) {
            status = "survey";
            document.getElementById("send_problem").innerHTML = problem;
          }
          else {
            status = "solving";
            document.getElementById("send_problem").innerHTML = problem;
          }
        }
        else {
          status = "survey";
          document.getElementById("send_problem").innerHTML = problem;
        }

        document.getElementById("send_status").innerHTML = status;
        document.getElementById("send_lang").innerHTML = lang;

      }

      window.requestAnimationFrame(upd, 1000);
    }

    upd();

    function deep_convert(args) {
      // Recursively converts an actual array back to a string representation, and puts quotes around strings
      // Used to format program output for each test case

      if (typeof args == "object") {
        var answer = "["
        for (var i = 0 ; i < args.length ; i++) {
          if (typeof args[i] == "number") {
            answer += args[i];
          }
          else if (typeof args[i] != "object") {
            answer += "\"" + args[i] + "\"";
          }
          else {
            answer += deep_convert(args[i]);
          }
          if (i < args.length - 1) {
            answer += ",";
          }
        }
        answer += "]";
        return answer;
      }
      else if (typeof args != "number") {
        return "\"" + args + "\"";
      }
      else {
        return args;
      }
    }

    function run(funcname, args) {
      var code = editor.getValue();
      code = code.split("\n");
      var x = 2;
      // Sets the initial code to eventually be run, which includes a function to retrieve input step by step
      //var newcode = "var retStr = \"\"\nvar result = \"\"\n\ntry { \nvar origStartTime = globalStartTime;\n";
      var newcode = "var retStr = \"\"\nvar result = \"\"\n\n\nvar origStartTime = globalStartTime;\n";

      // Adds time limit checks to the code
      // At every iteration, if more than 0.5s (or whatever is specified in TIME_LIMIT_MS) has passed, the program aborts and returns "Time Limit Exceeded"
      for (var i = 0 ; i < code.length ; i++) {
        newcode += code[i] + "\n";
        var contains = false;
        for (var j = 0 ; j < code[i].length ; j++) {
          contains |= (code[i][j] == '}');
        }
        if (!contains) {
          newcode += "if (globalStartTime != origStartTime || Date.now() - origStartTime > TIME_LIMIT_MS) { return \"Time Limit Exceeded\"; }\n";
        }
        newcode += "\n";
      }

      code = newcode;

      var newcode = "";

      //Converts any console.log statements to adding to the debug output string
      var finalPrint = "";
      var i = 0;
      while (i < code.length) {
        var print = true;
        for (var j = 0 ; j < 11 ; j++) {
          if (code[i+j] != "console.log".split("")[j]) {
            print = false;
          }
        }
        var inp = true;
        for (var j = 0 ; j < 10 ; j++) {
          if (code[i+j] != "readline()".split("")[j]) {
            inp = false;
          }
        }
        if (!print && !inp) {
          newcode += code[i];
          i++;
        }
        else if (inp) {
          newcode += "nextInput()";
          i += 10;
        }
        else {
          var j = 11;
          var bal = 0;
          var seen = false;
          var toPrint = "";

          // Parses possible nested parentheses in console.log statement. This has a possible edge case if there is a parenthesis inside of quotations which I will fix
          while ((bal != 0 || !seen) && i+j < code.length) {
            if (code[i+j] == '(') {
              bal++;
              seen = true;
            }
            else if (code[i+j] == ')') {
              bal--;
            }
            if (bal > 0 || code[i+j] == '(' || code[i+j] == ')') {
              toPrint += code[i+j];
            }
            j++;
          }

          newcode += "document.getElementById(\"jsdebug\").innerHTML += " + toPrint + " + \"<br>\"\n";

          i = i+j;
        }
      }

      args = deep_convert(args);

      newcode += "\n  result = " + funcname + "(" + args.split("").slice(1, args.length-1).join("") + ");\n\n\nglobal_num++;\nwindow.setTimeout(runTest, 1);\nreturn result;";

      // Runs the JS code, and updates the editor output
      try {
        var res = Function(newcode)();
        global_debug[global_num - 1] = document.getElementById("jsdebug").innerHTML;
        return res;
      }
      catch (e) {
        global_error[global_num - 1] = e;
        global_num++;
        global_debug[global_num - 1] = document.getElementById("jsdebug").innerHTML;
        window.setTimeout(runTest, 1);
        return e.toString();
      }

    }

    var oldValue = "";
    var ost;
    var orow;
    var ocol;

    function giveup() { //Function that is triggered when the user gives up on the current problem
      survey = true;
      correct = false;
    }

    function next(imp) { //Moves on to the next problem, but gives the user a survey first

      if (problem >= 0 && problem < tutorials.length && tutorials[problem].length) {
        survey = true;


        document.getElementById("survey").innerHTML = "";
        var st = "";
        for (var i = 0 ; i < tutorialtext[problem].length ; i++) {
          st += tutorialtext[problem][i];
        }
        document.getElementById("survey").innerHTML = st;

        tutorials[problem] = "";
        tutorial = true;

        document.getElementById("survey").innerHTML += "<button id=\"nextbutton\" onclick=next()>Next Problem</button>";
        return;
      }
      else {
        tutorial = false;
      }

      problem++;

      if (correct) {
        totsolved++;
      }

      if (problem == 0) {
        document.getElementById("surveyanswers").innerHTML = "presurvey" + "~~~" + answers.join("~~~");
        //Communicates the survey data with database.js, for updating firebase
      }
      else if (problem > problemset.length) {
        document.getElementById("surveyanswers").innerHTML = "postsurvey" + "~~~" + answers.join("~~~");
        //Communicates the survey data with database.js, for updating firebase
      }
      else {
        document.getElementById("surveyanswers").innerHTML = problemset[problem - 1] + "~~~" + answers.join("~~~");
        //Communicates the survey data with database.js, for updating firebase
      }

      if (problem > problemset.length) {
        survey = true;

        document.getElementById("survey").innerHTML = "";
        document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Experiment Complete!</p>";

        document.getElementById("survey").innerHTML += "<p id=\"surveysub\">You got through all of the problems, solving " + totsolved + " out of " + problemset.length + " total.</p>";

      }
      else if (problem == problemset.length) {
        survey = true;
      }
      else {
        if (!imp) {
          problemStart = Date.now();
        }

        updateProblem(problem+1, true);
        if (langs[problem] == "PYTHON") {
          lang = "python";
          editor.session.setMode("ace/mode/python");
        }
        if (langs[problem] == "JS") {
          lang = "js";
          editor.session.setMode("ace/mode/javascript");
        }
        survey = false;
        document.getElementById("survey").innerHTML = "";
        document.getElementById("survey").hidden = true;

        document.getElementById("prob").hidden = false;
        document.getElementById("testcases").hidden = false;
        document.getElementById("select").hidden = false;
        document.getElementById("select2").hidden = false;
      }

    }

    function updateSurvey(i, j) { //Updates the survey answers
      if (problem == -1) {
        answers[i] = presurveydata[i][2][j];
      }
      else if (problem == problemset.length) {
        answers[i] = postsurveydata[i][2][j];
      }
      else {
        answers[i] = surveydata[problem][i][2][j];
      }
      for (var k = 0 ; k < 1000 ; k++) {
        var dc = document.getElementById(i + "-" + k);
        if (!dc) break;
        if (k == j) {
          document.getElementById(i + "-" + k).style = "border-style: solid; border-color: rgb(0, 0, 255)";
        }
        else {
          document.getElementById(i + "-" + k).style = "border-style: none;";
        }
      }
    }

    var oe = "";
    var cop = "";
    var doneend = false;
    var lastEdit = 0;

    function updateEditor() {
      document.getElementById("probid").innerHTML = problem;
      if (langs[problem] == "JS") {
        document.getElementById("selectjs").style.width = "100%";
        document.getElementById("backgroundjs").style.width = "100%";
        document.getElementById("backgroundjs").hidden = false;
        document.getElementById("selectpython").style.width = "0%";
        document.getElementById("backgroundpython").style.width = "0%";
        document.getElementById("backgroundpython").hidden = true;
      }
      else if (langs[problem] == "PYTHON") {
        document.getElementById("selectpython").style.width = "100%";
        document.getElementById("selectpython").style.left = "0%";
        document.getElementById("backgroundpython").style.width = "100%";
        document.getElementById("backgroundpython").style.left = "0%";
        document.getElementById("backgroundpython").hidden = false;
        document.getElementById("selectjs").style.width = "0%";
        document.getElementById("selectjs").hidden = true;
        document.getElementById("backgroundjs").style.width = "0%";
        document.getElementById("backgroundjs").hidden = true;
      }
      else {
        document.getElementById("selectpython").style.width = "50%";
        document.getElementById("backgroundpython").style.width = "50%";
        document.getElementById("selectjs").style.width = "50%";
        document.getElementById("backgroundjs").style.width = "50%";
        document.getElementById("selectjs").hidden = false;

        document.getElementById("selectpython").style.left = "50%";
        document.getElementById("backgroundpython").style.left = "50%";
      }

      if (problem != -1) {
        var sig = data[problem][2][0];
        if (!editor.getValue().includes(sig)) {
          editor.setValue(oe);
          editor.clearSelection();
        }
      }

      if (keys[67] == 2) {
        cop = editor.getSelectedText(); //Checks if the user copied editor code
      }

      if (pasted && oe != editor.getValue() && !global_allowed) {
        var ok = oe + copyText;
        var real = editor.getValue();
        if (ok.split("").sort().join("") != real.split("").sort().join("")) { // Prevents the user from copying and pasting external code
          editor.setValue(oe);
          editor.clearSelection();
          editor.getSession().setUndoManager(new ace.UndoManager());
        }
      }
      if (pasted) {
        pasted = false;
      }

      oe = editor.getValue();

      if (survey) {
        editor.setReadOnly(true);
      }
      else {
        editor.setReadOnly(false);
      }

      if ((survey && !lastsurvey) || (problem >= problemset.length && !doneend)) {
        //Sets up the survey if the user just solved a problem
        var svd = surveydata[problem];
        if (problem == -1) {
          svd = presurveydata;
        }
        if (problem >= problemset.length) {
          svd = postsurveydata;
          doneend = true;
        }

        answers = [];
        for (var i = 0 ; i < svd.length ; i++) {
          if (svd[i][0] == 0) {
            answers.push("");
          }
          else if (svd[i][0] == 1) {
            answers.push(0);
          }
          else if (svd[i][0] == 2) {
            answers.push(svd[i][2]);
          }
        }
        document.getElementById("prob").hidden = true;
        document.getElementById("testcases").hidden = true;
        document.getElementById("select").hidden = true;
        document.getElementById("select2").hidden = true;
        document.getElementById("survey").hidden = false;
        document.getElementById("survey").innerHTML = "";
        if (problem == -1) {
          document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Experiment About to Start</p>";
        }
        else if (problem >= problemset.length) {
          document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Experiment Complete!</p>";
        }
        else if (imported) {
          document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Problem Complete</p>";
        }
        else if (correct) {
          document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Problem Solved</p>";
        }
        else {
          document.getElementById("survey").innerHTML += "<p id=\"surveytitle\">Problem Failed</p>";
        }
        document.getElementById("survey").innerHTML += "<p id=\"surveysub\">Please complete this quick survey:</p>";
        for (var i = 0 ; i < svd.length ; i++) {
          var question = svd[i];
          document.getElementById("survey").innerHTML += "<p id=\"question\">" + question[1] + "</p>";
          if (question[0] == 0) {
            document.getElementById("survey").innerHTML += "<input oninput=\"answers[" + i + "] = this.value;\" id=\"surveyinput\"></input>";
          }
          else if (question[0] == 1) {
            for (var j = 0 ; j < question[2].length ; j++) {
              document.getElementById("survey").innerHTML += "<button class=\"surveybutton\" onclick=updateSurvey(" + i + "," + j + ") id=\"" + i + "-" + j + "\">" + question[2][j] + "</button>";
            }

          }
          else if (question[0] == 2) {
            document.getElementById("survey").innerHTML += "<input type=\"range\" oninput=\"this.nextElementSibling.value = this.value; answers[" + i + "] = this.value;\" id=\"surveyslider\" min=" + question[2] + " max=" + question[3] + " value=" + question[2] + "></input>";
            document.getElementById("survey").innerHTML += "<output id=\"surveynum\">" + question[2] + "</output>";
          }
        }
        document.getElementById("survey").innerHTML += "<button id=\"nextbutton\" onclick=next()>Next Problem</button>";
      }

      lastsurvey = survey;

      document.getElementById("select").innerHTML = "Problem <strong>" + (problem+1) + "</strong> of <strong>" + problemset.length + "</strong>";
      var time = parseInt(times[problem] - (Date.now() - problemStart) / 1000);
      if (time < 0) {
        giveup();
      }
      var tms = time%60;
      if (tms<10) {
        tms = "0" + tms;
      }
      document.getElementById("timeleft").innerHTML = parseInt(time/60) + ":" + tms;
      var g = (time / times[problem]) * 255;
      var r = 255 - g;
      document.getElementById("timeleft").style = "color: rgb(" + r + "," + g + ",0)";

      if (solvedpy[problem] || solvedjs[problem]) {
        correct = true;
        survey = true;
      }

      if (document.getElementById("pyresult").innerHTML.length > 0) {
        jtest = document.getElementById("lasttest").innerHTML;
        jprob = document.getElementById("lastprob").innerHTML;
        jstart = document.getElementById("laststart").innerHTML;

        if (!(jtest != global_num || jprob != global_index || jstart != globalStartTime)) {

          global_num++;

          ans = document.getElementById("pyresult").innerHTML;

          var debug = document.getElementById("pydebug").innerHTML;

          aans = parse_testcase(ans)[0];


          global_actanswers[global_num - 1] = aans;
          global_answers[global_num - 1] = ans;


          var equal = (JSON.stringify(global_actanswers[global_num - 1]) == JSON.stringify(global_var_expected[global_num - 1]));

          global_results.push(equal);
          global_debug[global_num - 1] = debug;

          document.getElementById("pyresult").innerHTML = "";

          runTest();

          //Updates each testcase with the program output, if the user is coding in Python.
        }
      }

      var nv = editor.getValue();
      var pos = editor.getCursorPosition();
      var row = pos.row;
      var col = pos.column;


      if (nv != oldValue) {

        // Figures out exactly which characters were edited from one keystroke
        // This was a surprisingly difficult task, because in one keystroke the user could theoretically delete any number of characters and replace them with any number of characters (e.g. if they deleted a lot of code and pasted other code in simultaneously using Ctrl-V)

        nv = nv.split("");
        oldValue = oldValue.split("");

        var i = 0;
        var j = 0;

        while (i < nv.length) {
          if (i >= oldValue.length || nv[i] != oldValue[i]) break;
          i++;
        }

        while (j < nv.length && i+j < nv.length && i+j < oldValue.length) {
          if (j >= oldValue.length || nv[nv.length - j - 1] != oldValue[oldValue.length -  j - 1]) break;
          j++;
        }

        var newSlice = "";
        var oldSlice = "";

        for (var k = i ; nv.length - k - 1 >= j ; k++) {
          newSlice += nv[k];
        }
        for (var k = i ; oldValue.length - k - 1 >= j ; k++) {
          oldSlice += oldValue[k];
        }

        var line = 1;
        var char = 1;

        for (var k = 0 ; k < i ; k++) {
          if (oldValue[k] == '\n') {
            line++;
            char = 1;
          }
          else {
            char++;
          }
        }

        var edit;

        edit = [oldSlice, newSlice, line, char, i];

        lastEdit = Date.now() + "~~~" + edit.join("~~~");


        if (!imported) {
          document.getElementById("edit").innerHTML = Date.now() + "~~~" + edit.join("~~~");
        }
        //Communicates edit data with database.js for updating firebase
      }

      orow = row;
      ocol = col;

      //if (loadedDat) {
        oldValue = editor.getValue();
      //}

      ost = editor.getSelectedText();

      document.getElementById("text").innerHTML = editor.getValue().split("").join("~~~");

      document.getElementById("index").innerHTML = global_index;

      window.requestAnimationFrame(updateEditor, 1);

      imported = false;
    }

    updateEditor();

    </script>

    <script type="text/python">

#//Uses Brython to run Python code in JS - exec() in Python will execute Python code, and this was easier than running Python code directly in JS (doing so would likely require a server.)
from browser import document
from browser.timer import set_timeout, clear_timeout
import random
import time

finalStr = ""
debugStr = ""

inputIter = ""
x = 0

def deep_convert(args):
  if (isinstance(args, list)):
    answer = "["
    for i in range(0, len(args)):
      answer += deep_convert(args[i])
      if (i < len(args) - 1):
        answer += ", "
    answer += "]";
    return answer
  elif isinstance(args, int):
    return str(args);
  elif isinstance(args, str):
    return "\"" + args + "\""
  else:
    return "undefined"

def run():
  global finalStr
  global x
  global debugStr

  debugStr = ""

  set_timeout(run, 1);
  if (len(document.getElementById("sig").innerHTML) > 0):
    sig = document.getElementById("sig").innerHTML;

    tc = list(document.getElementById("args").innerHTML);

    prob = document.getElementById("index").innerHTML;
    testcase = document.getElementById("curtestcase").innerHTML;
    startTime = document.getElementById("starttime").innerHTML;

    document.getElementById("sig").innerHTML = "";

    gstart = time.time();

    tcs = "";
    args = [];
    bal = 0;
    for j in range(0, len(tc)):
      if tc[j] == " " and bal == 0:
        args.append(tcs);
        tcs = "";
      else:
        tcs += tc[j];
        if (tc[j] == "["):
          bal += 1
        if (tc[j] == "]"):
          bal -= 1

    args.append(tcs);

    for j in range(0, len(args)):
      inp = args[j];
      if (inp[0] == "\"" or inp[0] == "'"):
        args[j] = "\"" + "".join(list(args[j])[1:-1]) + "\""
      elif (inp[0] == "["):
        arrcode = "x = " + inp
        exec(arrcode, globals())
        args[j] = x
      else:
        args[j] = int(args[j])

    allCode = "".join(document.getElementById("text").innerHTML.split("~~~")).split("\n");
    imports = ""
    newCode = "def allcode():\n    import random\n    import time\n    start = time.time()\n";
    indent = 4


    for i in range(0, len(allCode)):
      if (len(allCode[i]) >= 4 and "".join(list(allCode[i])[:4]) == "from") or (len(allCode[i]) >= 6 and "".join(list(allCode[i])[:6]) == "import"):
        imports += allCode[i] + "\n"
        continue
      spaceCount = 0
      j = 0
      while j < len(allCode[i]) and allCode[i][j] == " ":
        spaceCount += 1
        j += 1
      if spaceCount == 2:
        indent = 2

      elcase = False
      ls = list(allCode[i])
      for j in range(0, len(ls) - 4):
        if "".join(ls[j:j+5]) == "else:" or "".join(ls[j:j+4]) == "elif":
          elcase = True
      if len(allCode[i]) and list(allCode[i])[-1] != " " and (not elcase):
        newCode += (" " * (spaceCount + indent)) + "if random.randint(1, 30) == 27 and time.time() - start >= 1.0:\n"
        newCode += (" " * (spaceCount + indent * 2)) + "return \"Time Limit Exceeded\"\n"
      newCode += (" " * indent) + allCode[i]
      newCode += "\n";
      if len(allCode[i]) >= spaceCount + 3 and "".join(list(allCode[i])[spaceCount:spaceCount+3]) == "def":
        newCode += (" " * indent * 2) + "global debugStr\n"
    newCode += "    return " + sig + "(" + ",".join([str(i) for i in args]) + ")\n"
    newCode += "finalStr = allcode()"
    newCode = list(newCode)

    finalCode = imports + "\n"

    i = 0
    while (i < len(newCode)):
      if newCode[i] != '&':
        finalCode += newCode[i]
        i += 1
      elif i < len(newCode) - 4 and "".join(list(newCode)[i:i+4]) == "&lt;":
        finalCode += "<"
        i += 4
      elif i < len(newCode) - 4 and "".join(list(newCode)[i:i+4]) == "&gt;":
        finalCode += ">"
        i += 4
      elif i < len(newCode) - 5 and "".join(list(newCode)[i:i+5]) == "&amp;":
        finalCode += "&"
        i += 5
      else:
        finalCode += newCode[i]
        i += 1

    newCode = finalCode

    newCode = newCode.split("\n")

    for i in range(0, len(newCode)):
      j = 0
      while j < len(newCode[i]) and newCode[i][j] == " ":
        j += 1

      if j < len(newCode[i]) - 6 and newCode[i][j] == "p" and newCode[i][j+1] == "r" and newCode[i][j+2] == "i" and newCode[i][j+3] == "n" and newCode[i][j+4] == "t" and newCode[i][j+5] == "(":
        newCode[i] = (" " * (j)) + "debugStr += str(" + "".join(list(newCode[i])[(6 + j):-1]) + ") + \"<br>\""

    newCode = "\n".join(newCode)

    #//Runs the Python code, storing all print() statements to the finalStr variable

    document.getElementById("lastprob").innerHTML = prob;
    document.getElementById("lasttest").innerHTML = testcase;
    document.getElementById("laststart").innerHTML = startTime;


    #print("executing: ")
    #print("about to execute this code:")
    #print(newCode)

    try:
      exec(newCode, globals());
    except Exception as e:
      print(e)
      document.getElementById("pyresult").innerHTML = str(e);
      document.getElementById("pydebug").innerHTML = debugStr;
      return;

    finalStr = deep_convert(finalStr)

    document.getElementById("pyresult").innerHTML = finalStr;

    document.getElementById("pydebug").innerHTML = debugStr;



run();

  </script>
  </body>
</html>
